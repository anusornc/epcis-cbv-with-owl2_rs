<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPCIS KG Clean Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; border-left: 4px solid; }
        .success { background: #d4edda; border-color: #28a745; color: #155724; }
        .error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .loading { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .query-section { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .clear { background: #6c757d; }
        .clear:hover { background: #545b62; }
        .console { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç EPCIS Knowledge Graph - Clean Test</h1>
        <p>This page tests the actual API integration without any complex JavaScript.</p>
        
        <div class="query-section">
            <h3>üß™ Test Custom SPARQL Query</h3>
            <textarea id="query-input" rows="4" placeholder="Enter your SPARQL query here...">SELECT * WHERE { ?s ?p ?o } LIMIT 5</textarea>
            <br><br>
            <button onclick="testCustomQuery()">Execute Query</button>
            <button onclick="clearResults()" class="clear">Clear Results</button>
        </div>
        
        <div id="query-result" class="result loading">Query: Not tested yet</div>
        
        <div class="query-section">
            <h3>üìä Query Results</h3>
            <div id="results-display">Results will appear here...</div>
        </div>
        
        <div class="query-section">
            <h3>üíª Console Output</h3>
            <div id="console-output" class="console">Console messages will appear here...</div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v1';
        
        function log(message) {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(message);
        }
        
        function updateResult(elementId, className, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${className}`;
            element.innerHTML = message;
        }
        
        function displayResults(data) {
            const resultsDisplay = document.getElementById('results-display');
            
            if (!data.results || !data.results.bindings || data.results.bindings.length === 0) {
                resultsDisplay.innerHTML = '<p>No results found</p>';
                return;
            }
            
            const bindings = data.results.bindings;
            const vars = data.head.vars;
            
            let html = `<p><strong>Found ${bindings.length} results</strong></p>`;
            html += '<table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa;">';
            
            vars.forEach(v => {
                html += `<th style="padding: 8px; border: 1px solid #ddd;">${v}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            bindings.forEach((binding, index) => {
                html += `<tr style="${index % 2 === 0 ? 'background: white;' : 'background: #f8f9fa;'}">`;
                vars.forEach(v => {
                    const value = binding[v];
                    if (value) {
                        let displayValue = value.value;
                        if (value.type === 'uri') {
                            displayValue = `<a href="${value.value}" target="_blank" style="color: #007bff;">${value.value}</a>`;
                        }
                        html += `<td style="padding: 8px; border: 1px solid #ddd; font-size: 12px;">${displayValue}</td>`;
                    } else {
                        html += '<td style="padding: 8px; border: 1px solid #ddd;">-</td>';
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            resultsDisplay.innerHTML = html;
        }
        
        async function testCustomQuery() {
            const queryInput = document.getElementById('query-input');
            const query = queryInput.value.trim();
            
            if (!query) {
                updateResult('query-result', 'error', '‚ùå Query: No query provided');
                log('Error: No query provided');
                return;
            }
            
            log(`Testing custom query: ${query}`);
            updateResult('query-result', 'loading', '‚è≥ Query: Testing...');
            
            try {
                log('Sending request to SPARQL API...');
                const response = await fetch(`${API_BASE}/sparql/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        default_graph_uri: null,
                        named_graph_uri: null
                    })
                });
                
                log(`Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`);
                
                const resultCount = data.results && data.results.bindings ? data.results.bindings.length : 0;
                updateResult('query-result', 'success', 
                    `‚úÖ Query: ${resultCount} results found, status: ${data.status}`);
                
                // Display the actual results
                displayResults(data);
                
                log(`Query completed successfully with ${resultCount} results`);
                
            } catch (error) {
                log(`Error: ${error.message}`);
                updateResult('query-result', 'error', `‚ùå Query: Failed - ${error.message}`);
            }
        }
        
        function clearResults() {
            updateResult('query-result', 'loading', 'Query: Not tested yet');
            document.getElementById('results-display').innerHTML = 'Results will appear here...';
            document.getElementById('console-output').innerHTML = 'Console messages will appear here...';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded. Ready to test queries.');
            log('API Base URL: ' + API_BASE);
        });
    </script>
</body>
</html>